name: Production Release

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  release-production:
    name: Release to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          ref: main

      - name: Update version badge in README
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION_NUM="${VERSION#v}"

          # Update the version badge
          sed -i "s/version-[0-9]*\.[0-9]*\.[0-9]*-blue/version-${VERSION_NUM}-blue/g" README.md

          # Check if there are changes
          if git diff --quiet README.md; then
            echo "No changes to README.md"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        id: check_changes

      - name: Create PR for version badge update
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          BRANCH="chore/update-version-badge-${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add README.md
          git commit -m "chore: update version badge to ${VERSION}"
          git push origin "$BRANCH"

          # Create and auto-merge PR
          gh pr create --title "chore: update version badge to ${VERSION}" \
            --body "Automated PR to update version badge after release ${VERSION}" \
            --base main \
            --head "$BRANCH"

          gh pr merge "$BRANCH" --auto --squash --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel (Production)
        id: deploy
        run: |
          URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## ðŸš€ Production Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Production** | [aquarioufpb.com](https://aquarioufpb.com) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Vercel URL** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Notes:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.release.body }}" >> $GITHUB_STEP_SUMMARY
