generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum PapelPlataforma {
  USER
  MASTER_ADMIN
}

enum TipoToken {
  VERIFICACAO_EMAIL
  RESET_SENHA
}

enum TipoEntidade {
  LABORATORIO
  GRUPO
  LIGA_ACADEMICA
  EMPRESA
  ATLETICA
  CENTRO_ACADEMICO
  OUTRO
}

enum PapelMembro {
  ADMIN
  MEMBRO
}

enum StatusGuia {
  ATIVO
  INATIVO
  RASCUNHO
}

enum NaturezaDisciplina {
  OBRIGATORIA
  OPTATIVA
  COMPLEMENTAR_FLEXIVA
}

enum CategoriaEvento {
  MATRICULA_INGRESSANTES
  MATRICULA_VETERANOS
  REMATRICULA
  MATRICULA_EXTRAORDINARIA
  PONTO_FACULTATIVO
  FERIADO
  EXAMES_FINAIS
  REGISTRO_MEDIAS_FINAIS
  COLACAO_DE_GRAU
  INICIO_PERIODO_LETIVO
  TERMINO_PERIODO_LETIVO
  OUTRA
}

enum StatusProjeto {
  RASCUNHO
  PUBLICADO
  ARQUIVADO
}

enum TipoConteudo {
  MARKDOWN
  HTML
  TEXTO_SIMPLES
}

// ============================================================================
// CAMPUS & CENTRO & CURSO (Core organizational structure)
// ============================================================================

model Campus {
  id      String   @id @default(uuid())
  nome    String   @unique
  centros Centro[]
}

model Centro {
  id        String  @id @default(uuid())
  nome      String  @unique
  sigla     String  @unique
  descricao String?

  campusId String
  campus   Campus @relation(fields: [campusId], references: [id])

  cursos    Curso[]
  usuarios  Usuario[]
  entidades Entidade[]
}

model Curso {
  id       String @id @default(uuid())
  nome     String @unique
  centroId String

  centro     Centro      @relation(fields: [centroId], references: [id])
  usuarios   Usuario[]
  guias      Guia[]
  curriculos Curriculo[]
}

// ============================================================================
// USUARIO & AUTH
// ============================================================================

model Usuario {
  id                String           @id @default(uuid())
  nome              String
  email             String?          @unique
  matricula         String?          @unique
  slug              String?          @unique
  senhaHash         String?
  permissoes        String[]         @default([])
  papelPlataforma   PapelPlataforma  @default(USER)
  eVerificado       Boolean          @default(false)
  eFacade           Boolean          @default(false)
  urlFotoPerfil     String?
  criadoEm          DateTime         @default(now())
  atualizadoEm      DateTime         @updatedAt

  centroId String
  cursoId  String

  centro Centro @relation(fields: [centroId], references: [id])
  curso  Curso  @relation(fields: [cursoId], references: [id])

  membroDeEntidades      MembroEntidade[]
  tokensVerificacao      TokenVerificacao[]
  disciplinasConcluidas  DisciplinaConcluida[]
  projetosAutor          ProjetoAutor[]

  @@index([email])
  @@index([matricula])
  @@index([eFacade])
  @@index([slug])
}

model TokenVerificacao {
  id        String    @id @default(uuid())
  usuarioId String
  token     String    @unique
  tipo      TipoToken
  expiraEm  DateTime
  usadoEm   DateTime?
  criadoEm  DateTime  @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([usuarioId])
  @@index([expiraEm])
}

// ============================================================================
// ENTIDADES
// ============================================================================

model Entidade {
  id           String       @id @default(uuid())
  nome         String
  slug         String?      @unique
  subtitle     String?
  descricao    String?
  tipo         TipoEntidade
  urlFoto      String?
  contato      String?
  instagram    String?
  linkedin     String?
  website      String?
  location     String?
  foundingDate DateTime?
  metadata     Json?        @default("{}")
  centroId     String

  centro  Centro           @relation(fields: [centroId], references: [id])
  membros MembroEntidade[]
  cargos  Cargo[]
  projetos Projeto[]

  @@unique([nome, tipo])
  @@index([slug])
}

model Cargo {
  id         String   @id @default(uuid())
  nome       String
  descricao  String?
  ordem      Int      @default(0)
  entidadeId String
  criadoEm   DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  entidade Entidade        @relation(fields: [entidadeId], references: [id], onDelete: Cascade)
  membros  MembroEntidade[]

  @@index([entidadeId])
  @@index([ordem])
}

model MembroEntidade {
  id         String      @id @default(uuid())
  usuarioId  String
  entidadeId String
  papel      PapelMembro
  cargoId    String?
  startedAt  DateTime    @default(now())
  endedAt    DateTime?

  usuario  Usuario  @relation(fields: [usuarioId], references: [id])
  entidade Entidade @relation(fields: [entidadeId], references: [id])
  cargo    Cargo?   @relation(fields: [cargoId], references: [id], onDelete: SetNull)

  @@index([usuarioId, entidadeId])
  @@index([endedAt])
  @@index([cargoId])
}

// ============================================================================
// GUIAS
// ============================================================================

model Guia {
  id           String     @id @default(uuid())
  titulo       String
  slug         String     @unique
  descricao    String?
  status       StatusGuia @default(RASCUNHO)
  cursoId      String?
  tags         String[]   @default([])
  criadoEm     DateTime   @default(now())
  atualizadoEm DateTime   @updatedAt

  curso  Curso?      @relation(fields: [cursoId], references: [id])
  secoes SecaoGuia[]

  @@index([cursoId])
  @@index([slug])
  @@index([status])
  @@index([criadoEm])
}

model SecaoGuia {
  id           String     @id @default(uuid())
  guiaId       String
  titulo       String
  slug         String
  ordem        Int
  conteudo     String?
  status       StatusGuia @default(RASCUNHO)
  criadoEm     DateTime   @default(now())
  atualizadoEm DateTime   @updatedAt

  guia      Guia           @relation(fields: [guiaId], references: [id], onDelete: Cascade)
  subsecoes SubSecaoGuia[]

  @@index([guiaId])
  @@index([ordem])
  @@index([status])
}

model SubSecaoGuia {
  id           String     @id @default(uuid())
  secaoId      String
  titulo       String
  slug         String
  ordem        Int
  conteudo     String?
  status       StatusGuia @default(RASCUNHO)
  criadoEm     DateTime   @default(now())
  atualizadoEm DateTime   @updatedAt

  secao SecaoGuia @relation(fields: [secaoId], references: [id], onDelete: Cascade)

  @@index([secaoId])
  @@index([ordem])
  @@index([status])
}

// ============================================================================
// CURRICULO & DISCIPLINAS
// ============================================================================

model Curriculo {
  id           String   @id @default(uuid())
  codigo       String
  ativo        Boolean  @default(false)
  cursoId      String
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  curso       Curso                @relation(fields: [cursoId], references: [id])
  disciplinas CurriculoDisciplina[]

  @@unique([cursoId, codigo])
  @@index([cursoId])
}

model Disciplina {
  id                  String  @id @default(uuid())
  codigo              String  @unique
  nome                String
  cargaHorariaTotal   Int?
  cargaHorariaTeoria  Int?
  cargaHorariaPratica Int?
  departamento        String?
  modalidade          String?
  ementa              String?

  curriculos           CurriculoDisciplina[]
  preRequisitoEm       PreRequisitoDisciplina[]
  equivalenciasOrigem  Equivalencia[] @relation("disciplinaOrigem")
  equivalenciasDestino Equivalencia[] @relation("disciplinaEquivalente")
  concluidaPor         DisciplinaConcluida[]
}

model CurriculoDisciplina {
  id           String              @id @default(uuid())
  curriculoId  String
  disciplinaId String
  natureza     NaturezaDisciplina
  periodo      Int

  curriculo     Curriculo                @relation(fields: [curriculoId], references: [id], onDelete: Cascade)
  disciplina    Disciplina               @relation(fields: [disciplinaId], references: [id])
  preRequisitos PreRequisitoDisciplina[]

  @@unique([curriculoId, disciplinaId])
  @@index([curriculoId])
  @@index([disciplinaId])
}

model PreRequisitoDisciplina {
  id                    String @id @default(uuid())
  curriculoDisciplinaId String
  disciplinaRequeridaId String

  curriculoDisciplina CurriculoDisciplina @relation(fields: [curriculoDisciplinaId], references: [id], onDelete: Cascade)
  disciplinaRequerida Disciplina          @relation(fields: [disciplinaRequeridaId], references: [id])

  @@unique([curriculoDisciplinaId, disciplinaRequeridaId])
  @@index([curriculoDisciplinaId])
}

model Equivalencia {
  id                      String @id @default(uuid())
  disciplinaOrigemId      String
  disciplinaEquivalenteId String

  disciplinaOrigem      Disciplina @relation("disciplinaOrigem", fields: [disciplinaOrigemId], references: [id])
  disciplinaEquivalente Disciplina @relation("disciplinaEquivalente", fields: [disciplinaEquivalenteId], references: [id])

  @@unique([disciplinaOrigemId, disciplinaEquivalenteId])
}

model DisciplinaConcluida {
  id           String   @id @default(uuid())
  usuarioId    String
  disciplinaId String
  concluidaEm  DateTime @default(now())

  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  disciplina Disciplina @relation(fields: [disciplinaId], references: [id])

  @@unique([usuarioId, disciplinaId])
  @@index([usuarioId])
}

// ============================================================================
// CALENDARIO ACADEMICO
// ============================================================================

model SemestreLetivo {
  id           String   @id @default(uuid())
  nome         String   @unique
  dataInicio   DateTime
  dataFim      DateTime
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  eventos EventoCalendario[]

  @@index([dataInicio])
  @@index([dataFim])
}

model EventoCalendario {
  id           String          @id @default(uuid())
  descricao    String
  dataInicio   DateTime
  dataFim      DateTime
  categoria    CategoriaEvento @default(OUTRA)
  semestreId   String
  criadoEm     DateTime        @default(now())
  atualizadoEm DateTime        @updatedAt

  semestre SemestreLetivo @relation(fields: [semestreId], references: [id], onDelete: Cascade)

  @@index([semestreId])
  @@index([dataInicio])
  @@index([categoria])
}

// ============================================================================
// PROJETOS E AUTORES
// ============================================================================

model Projeto {
  id             String        @id @default(uuid())
  titulo         String
  slug           String        @unique
  subtitulo      String?
  descricao      String?
  textContent    String?
  tipoConteudo   TipoConteudo  @default(MARKDOWN)
  urlImagem      String?
  status         StatusProjeto @default(RASCUNHO)
  tags           String[]      @default([])
  dataInicio     DateTime?
  dataFim        DateTime?
  urlRepositorio String?
  urlDemo        String?
  urlPublicacao  String?
  criadoEm       DateTime      @default(now())
  atualizadoEm   DateTime      @updatedAt
  publicadoEm    DateTime?

  autores    ProjetoAutor[]
  entidadeId String?
  entidade   Entidade?      @relation(fields: [entidadeId], references: [id])

  @@index([slug])
  @@index([status])
  @@index([entidadeId])
  @@index([criadoEm])
  @@index([publicadoEm])
}

model ProjetoAutor {
  id              String   @id @default(uuid())
  projetoId       String
  usuarioId       String   // ID do Usuario (autor interno)
  autorPrincipal  Boolean  @default(false)

  projeto Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  usuario Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([projetoId, usuarioId])
  @@index([projetoId])
  @@index([usuarioId])
  @@index([autorPrincipal])
}


